{% extends "base.html" %}

{% block title %}Panel Principal{% endblock %}

{% block content %}
<div class="container py-4">

  <!-- Mensaje de Bienvenida y Resumen -->
  <div class="alert alert-info text-center mb-4">
    <h3>Bienvenido, {{ current_user.name }}</h3>
    <p>Rol: <strong>{{ current_user.role|capitalize }}</strong></p>
    {% if current_user.role == 'admin' %}
      <p>Accede a los paneles de administraci√≥n para gestionar t√©cnicos, huertos, bodegas y recomendaciones.</p>
    {% else %}
      <p>Consulta tus asignaciones y recomendaciones para optimizar tu gesti√≥n de campo.</p>
    {% endif %}
  </div>

  {% if current_user.role == 'admin' %}
    <!-- Panel de Indicadores Administrativos -->
    <div class="row mb-4">
      <!-- Total de T√©cnicos -->
      <div class="col-md-3 mb-3">
        <div class="card text-white bg-primary shadow-sm">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <i class="bi bi-person-lines-fill fs-2 me-3"></i>
              <div>
                <h4 class="card-title mb-0">{{ tecnicos|length }}</h4>
                <small>T√©cnicos</small>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Total de Huertos -->
      <div class="col-md-3 mb-3">
        <div class="card text-white bg-success shadow-sm">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <i class="bi bi-tree fs-2 me-3"></i>
              <div>
                <h4 class="card-title mb-0">{{ huertos|length }}</h4>
                <small>Huertos</small>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Total de Bodegas -->
      <div class="col-md-3 mb-3">
        <div class="card text-white bg-warning shadow-sm">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <i class="bi bi-box-seam fs-2 me-3"></i>
              <div>
                <h4 class="card-title mb-0">{{ bodegas|length }}</h4>
                <small>Bodegas</small>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- √öltimas Recomendaciones -->
      <div class="col-md-3 mb-3">
        <div class="card text-white bg-secondary shadow-sm">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <i class="bi bi-chat-left-text fs-2 me-3"></i>
              <div>
                <h4 class="card-title mb-0">{{ ultimas_recomendaciones|length }}</h4>
                <small>Recomendaciones</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Acciones Administrativas -->
    <div class="d-flex flex-wrap gap-2 mb-4">
      <a href="{{ url_for('admin.crear_tecnico') }}" class="btn btn-outline-primary">
        <i class="bi bi-person-plus"></i> Crear T√©cnico
      </a>
      <a href="{{ url_for('admin.recomendar') }}" class="btn btn-outline-warning">
        <i class="bi bi-chat-left-dots"></i> Asignar Recomendaci√≥n
      </a>
      <a href="{{ url_for('admin.crear_huerto') }}" class="btn btn-outline-success">
        <i class="bi bi-tree-fill"></i> Crear Huerto
      </a>
      <a href="{{ url_for('admin.crear_bodega') }}" class="btn btn-outline-success">
        <i class="bi bi-plus-circle"></i> Crear Bodega
      </a>
      <a href="{{ url_for('admin.listar_bodegas') }}" class="btn btn-outline-success">
        <i class="bi bi-box-seam"></i> Ver Bodegas
      </a>
    </div>

    <!-- T√©cnicos Registrados -->
    <div class="card mb-4 shadow-sm">
      <div class="card-header bg-light">
        <strong><i class="bi bi-people"></i> T√©cnicos Registrados</strong>
      </div>
      <div class="card-body">
        <ul class="list-group">
          {% for tecnico in tecnicos %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              {{ tecnico.name }} ‚Äî {{ tecnico.email }}
              <span class="badge bg-success">ID: {{ tecnico.id }}</span>
            </li>
          {% else %}
            <li class="list-group-item text-muted">No hay t√©cnicos registrados a√∫n.</li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <!-- √öltimas Recomendaciones -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-light">
        <strong><i class="bi bi-list-check"></i> √öltimas Recomendaciones Enviadas</strong>
      </div>
      <div class="card-body">
        <ul class="list-group">
          {% for r in ultimas_recomendaciones %}
            <li class="list-group-item">
              {{ r.fecha.strftime('%d-%m-%Y') }} ‚Äî <strong>{{ r.tecnico.name }}</strong>: {{ r.contenido[:60] }}...
            </li>
          {% else %}
            <li class="list-group-item text-muted">A√∫n no se han enviado recomendaciones.</li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <!-- Bodegas Registradas -->
    <div class="container mt-4">
      <h2 class="text-success mb-4">
        <i class="bi bi-box-seam"></i> Bodegas Registradas (Total: {{ bodegas|length }})
      </h2>
      
      <div class="row row-cols-1 row-cols-md-2 g-4">
        {% for bodega in bodegas %}
          <div class="col">
            <div class="card border-success shadow-sm h-100">
              <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <strong><i class="bi bi-house-door-fill"></i> {{ bodega.nombre }}</strong>
                <small>
                  {% if bodega.huerto %}
                    {{ bodega.huerto.nombre }}
                  {% else %}
                    Sin huerto
                  {% endif %}
                </small>
              </div>
              <div class="card-body">
                <p>
                  <i class="bi bi-geo-alt-fill text-success"></i>
                  <strong>Ubicaci√≥n:</strong> {{ bodega.ubicacion or "No especificada" }}
                </p>
                <p>
                  <i class="bi bi-person-circle text-success"></i>
                  <strong>Responsable:</strong>
                  {% if bodega.responsable %}
                    {{ bodega.responsable.name }}
                  {% else %}
                    Sin asignar
                  {% endif %}
                </p>
                <a href="{{ url_for('admin.ver_quimicos', bodega_id=bodega.id) }}" class="btn btn-outline-success btn-sm mt-2">
                  Ver qu√≠micos
                </a>
              </div>
            </div>
          </div>
        {% else %}
          <div class="col-12">
            <div class="alert alert-info text-center">
              <i class="bi bi-info-circle"></i> No hay bodegas registradas a√∫n.
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

  {% elif current_user.role == 'tecnico' %}
    <!-- Panel para T√©cnicos -->
    <div class="alert alert-success shadow-sm d-flex align-items-center mb-4">
      <i class="bi bi-megaphone fs-3 me-3"></i>
      <div>
        <h5 class="mb-1">Instrucciones T√©cnicas</h5>
        <p class="mb-0">Tu ingeniero agr√≥nomo ha enviado las siguientes recomendaciones para tu gesti√≥n de campo.</p>
      </div>
    </div>

    <h4 class="text-success mb-3"><i class="bi bi-tree"></i> Mis Huertos</h4>
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
      {% for h in huertos %}
        <div class="col">
          <div class="card border-success shadow-sm h-100">
            <div class="card-header bg-success text-white">
              <h5 class="card-title mb-0"><i class="bi bi-tree-fill"></i> {{ h.nombre }}</h5>
            </div>
            <div class="card-body">
              <p><i class="bi bi-geo-alt-fill text-success"></i> <strong>Ubicaci√≥n:</strong> {{ h.ubicacion }}</p>
              <p><i class="bi bi-flower2 text-success"></i> <strong>Cultivo:</strong> {{ h.tipo_cultivo }}</p>
              <p><i class="bi bi-rulers text-success"></i> <strong>Superficie:</strong> {{ h.superficie_ha }} ha</p>
              <p><i class="bi bi-calendar-check text-success"></i> <strong>Siembra:</strong> {{ h.fecha_siembra.strftime('%d-%m-%Y') }}</p>
            </div>
          </div>
        </div>
      {% else %}
        <div class="col-12">
          <div class="alert alert-info text-center">
            <i class="bi bi-info-circle"></i> No tienes huertos asignados a√∫n.
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- Recomendaciones Recientes -->
    <h4 class="text-success mb-3 mt-5"><i class="bi bi-clipboard-check"></i> Recomendaciones Recientes</h4>
    <div class="list-group shadow-sm">
      {% for r in recomendaciones %}
        <div class="list-group-item list-group-item-action border-start border-success border-4">
          <div class="d-flex w-100 justify-content-between">
            <h6 class="mb-1"><i class="bi bi-calendar-event text-success"></i> {{ r.fecha.strftime('%d-%m-%Y') }}</h6>
            {% if r.autor %}
              <small class="text-muted">Emitida por: {{ r.autor.name }}</small>
            {% endif %}
          </div>
          <p class="mb-1">üìå {{ r.contenido }}</p>
        </div>
      {% else %}
        <div class="list-group-item text-muted text-center">No tienes recomendaciones a√∫n.</div>
      {% endfor %}
    </div>
  {% endif %}

</div>
{% endblock %}
