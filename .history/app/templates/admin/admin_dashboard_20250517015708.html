{% extends "base.html" %}

{% block title %}Panel Administrativo{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
      <div class="position-sticky pt-3">
        <ul class="nav flex-column">
          <li class="nav-item mb-1">
            <a class="nav-link active" href="{{ url_for('admin.admin_dashboard') }}">
              <i class="bi bi-speedometer2"></i> Dashboard
            </a>
          </li>
          <!-- Técnicos -->
          <li class="nav-item">
            <a class="nav-link" data-bs-toggle="collapse" href="#submenuTecnicos" role="button" aria-expanded="false">
              <i class="bi bi-people"></i> Técnicos
            </a>
            <div class="collapse ps-3" id="submenuTecnicos">
              <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
                <li><a href="{{ url_for('admin.crear_tecnicos') }}" class="nav-link">Ver Técnicos</a></li>
                <li><a href="{{ url_for('admin.crear_tecnico') }}" class="nav-link">Crear Técnico</a></li>
              </ul>
            </div>
          </li>
          <!-- Huertos -->
          <li class="nav-item">
            <a class="nav-link" data-bs-toggle="collapse" href="#submenuHuertos" role="button" aria-expanded="false">
              <i class="bi bi-tree-fill"></i> Huertos
            </a>
            <div class="collapse ps-3" id="submenuHuertos">
              <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
                <li><a href="{{ url_for('admin.dashboard') }}#globalHuertos" class="nav-link">Vista Global</a></li>
                <li><a href="{{ url_for('admin.listar_huertos') }}" class="nav-link">Ver Huertos</a></li>
                <li><a href="{{ url_for('admin.crear_huerto') }}" class="nav-link">Crear Huerto</a></li>
                <li><a href="{{ url_for('admin.control_campo') }}" class="nav-link">Estado de Campo</a></li>
              </ul>
            </div>
          </li>
          <!-- Bodegas -->
          <li class="nav-item">
            <a class="nav-link" data-bs-toggle="collapse" href="#submenuBodegas" role="button" aria-expanded="false">
              <i class="bi bi-box-seam"></i> Bodegas
            </a>
            <div class="collapse ps-3" id="submenuBodegas">
              <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
                <li><a href="{{ url_for('admin.listar_bodegas') }}" class="nav-link">Ver Bodegas</a></li>
                <li><a href="{{ url_for('admin.crear_bodega') }}" class="nav-link">Crear Bodega</a></li>
              </ul>
            </div>
          </li>
          <!-- Recomendaciones -->
          <li class="nav-item">
            <a class="nav-link" data-bs-toggle="collapse" href="#submenuRec" role="button" aria-expanded="false">
              <i class="bi bi-chat-left-dots"></i> Recomendaciones
            </a>
            <div class="collapse ps-3" id="submenuRec">
              <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
                <li><a href="{{ url_for('admin.recomendar') }}" class="nav-link">Enviar Recomendación</a></li>
                <li><a href="{{ url_for('admin.historial_recomendaciones') }}" class="nav-link">Historial</a></li>
              </ul>
            </div>
          </li>
        </ul>
      </div>
    </nav>

    <!-- Main content -->
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
      <!-- Filtro de Huertos -->
      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-4 pb-2 mb-4 border-bottom">
        <h1 class="h2">Dashboard</h1>
        <form class="d-flex" method="get" action="{{ url_for('admin.dashboard') }}">
          <select name="huerto" class="form-select me-2">
            <option value="">Todos los Huertos</option>
            {% for h in huertos %}
            <option value="{{ h.id }}" {% if request.args.get('huerto')|int == h.id %}selected{% endif %}>{{ h.nombre }}</option>
            {% endfor %}
          </select>
          <button type="submit" class="btn btn-outline-primary">Filtrar</button>
        </form>
      </div>

      <!-- Notificaciones -->
      {% if notificaciones %}
      <div class="alert alert-light border-start border-4 border-success shadow-sm mb-4">
        <h5><i class="bi bi-bell-fill text-success"></i> Notificaciones</h5>
        <ul class="mb-0 ps-3">
          {% for n in notificaciones %}
            <li><strong>{{ n.titulo }}</strong> — {{ n.mensaje }} <small class="text-muted">({{ n.fecha.strftime('%d-%m-%Y') }})</small></li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

      <!-- Estadísticas generales -->
      {% if current_user.role == 'admin' %}
      <div class="row g-3 mb-4">
        {% set stats = [
          {'icon':'person-lines-fill','count': tecnicos|length, 'label':'Técnicos','color':'primary'},
          {'icon':'tree-fill','count': huertos|length,       'label':'Huertos','color':'success'},
          {'icon':'box-seam','count': bodegas|length,       'label':'Bodegas','color':'warning'},
          {'icon':'list-check','count': ultimas_recomendaciones|length,'label':'Reco.','color':'secondary'}
        ] %}
        {% for item in stats %}
        <div class="col-md-3">
          <div class="card text-white bg-{{ item.color }} shadow-sm h-100">
            <div class="card-body d-flex align-items-center">
              <i class="bi bi-{{ item.icon }} fs-1 me-3"></i>
              <div>
                <h3 class="mb-0">{{ item.count }}</h3>
                <small>{{ item.label }}</small>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Vista Global de Huertos con DataTable -->
      <div id="globalHuertos" class="mb-5">
        <h3 class="mb-3"><i class="bi bi-tree-fill"></i> Vista Global de Huertos</h3>
        <table id="tableHuertos" class="table table-striped table-bordered">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Ubicación</th>
              <th>Superf. (ha)</th>
              <th>Cultivo</th>
              <th>Siembra</th>
              <th>Técnico</th>
            </tr>
          </thead>
          <tbody>
            {% for h in huertos %}
            <tr>
              <td>{{ h.nombre }}</td>
              <td>{{ h.ubicacion }}</td>
              <td>{{ h.superficie_ha }}</td>
              <td>{{ h.tipo_cultivo }}</td>
              <td>{{ h.fecha_siembra.strftime('%d-%m-%Y') }}</td>
              <td>{{ h.responsable.name }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}

      {% block extra_content %}{% endblock %}

    </main>
  </div>
</div>

{% endblock %}

{% block scripts %}
  {{ super() }}
  <!-- DataTables JS y CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" />
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var table = $('#tableHuertos').DataTable({
        pageLength: 10,
        lengthMenu: [ [10, 25, 50, 100], [10, 25, 50, 100] ],
        language: {
          url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
        }
      });
    });
  </script>
{% endblock %}
