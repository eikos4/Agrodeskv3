{% extends "base.html" %}
{% block title %}Panel Administrativo | AgroDESK{% endblock %}

{% block content %}
<style>
  /* ======== ESTILO GLOBAL ======== */
  body {
    background: linear-gradient(135deg, #f9faf9, #e8f3ee);
  }
  h2, h3, h4 { color: #0a3637; font-weight: 800; }

  .card {
    border: none;
    border-radius: 1rem;
    transition: all 0.3s ease;
  }
  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.08);
  }

  /* ======== KPIs ======== */
  .kpi-card {
    background: linear-gradient(140deg, #0a3637, #007d66);
    color: #fff;
    border-radius: 1rem;
    padding: 1.5rem;
    text-align: center;
    box-shadow: 0 8px 28px rgba(10,54,55,0.18);
    transition: all 0.3s ease;
  }
  .kpi-card:hover {
    background: linear-gradient(140deg, #007d66, #00b47e);
  }
  .kpi-icon { font-size: 2rem; opacity: 0.9; }
  .kpi-value { font-size: 2rem; font-weight: 800; }
  .kpi-label { font-size: .9rem; opacity: .9; }

  /* ======== AGROBOT ======== */
  .agrobot-fab {
    position: fixed; bottom: 1rem; right: 1rem;
    z-index: 1050; border-radius: 50%;
  }
  .alert-agrobot {
    border-left: 5px solid #00b47e;
    background: #f0fff8;
  }

  /* ======== HUERTOS ======== */
  .huerto-card {
    border-left: 5px solid #00b47e33;
  }
  .huerto-card:hover {
    border-left: 5px solid #00b47e;
  }
  .huerto-card .badge { font-size: .8rem; }

  /* ======== BODEGAS ======== */
  .bodega-card {
    border-left: 5px solid #ffc10755;
  }
  .bodega-card:hover {
    border-left: 5px solid #ffc107;
  }

  /* ======== TABLAS ======== */
  .table td { vertical-align: middle; }

  /* ======== ANIMACIONES ======== */
  @keyframes fadeIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:none;} }
  .fade-in { animation: fadeIn .6s ease both; }
</style>

<div class="container py-4">

  <!-- ========= AGROBOT ========= -->
  <div id="agrobotBox" class="alert alert-agrobot shadow-sm p-4 mb-4 fade-in">
    <div class="d-flex align-items-start gap-3">
      <div class="fs-1">ðŸ¤–</div>
      <div class="flex-grow-1">
        <h4 class="fw-bold mb-2 text-success">AgroBot Administrativo</h4>
        <p class="mb-2">
          Bienvenido a <b>AgroDESK</b> ðŸŒ±. Como administrador puedes gestionar huertos, bodegas y tÃ©cnicos.
          <br>Recuerda: <strong>si cambias una contraseÃ±a</strong>, <span class="text-danger">avisa al tÃ©cnico en terreno</span> para evitar bloqueos en su acceso mÃ³vil.
        </p>
        <div class="d-flex flex-wrap gap-2">
          <a href="{{ url_for('admin.crear_huerto') }}" class="btn btn-success btn-sm"><i class="bi bi-tree"></i> Nuevo Huerto</a>
          <a href="{{ url_for('admin.crear_bodega') }}" class="btn btn-warning btn-sm"><i class="bi bi-box"></i> Nueva Bodega</a>
          <a href="{{ url_for('admin.crear_tecnico') }}" class="btn btn-info text-white btn-sm"><i class="bi bi-person-plus"></i> Nuevo TÃ©cnico</a>
        </div>
      </div>
      <button id="hideAgrobotBtn" class="btn btn-outline-success btn-sm ms-auto">
        <i class="bi bi-x-lg"></i> Ocultar
      </button>
    </div>
  </div>
  <button id="showAgrobotBtn" class="btn btn-success agrobot-fab" style="display:none;">ðŸ¤–</button>

  <!-- ========= ENCABEZADO ========= -->
  <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between mb-4">
    <div>
      <h2 class="mb-1 text-success"><i class="bi bi-person-circle"></i> Hola, {{ current_user.name }}</h2>
      <div class="text-muted small">Rol: <strong>{{ current_user.role|capitalize }}</strong></div>
    </div>
  </div>

  <!-- ========= KPIs ========= -->
  <div class="row g-3 mb-5">
    <div class="col-6 col-md-3"><div class="kpi-card"><div class="kpi-icon"><i class="bi bi-tree"></i></div><div class="kpi-value">{{ huertos|length }}</div><div class="kpi-label">Huertos</div></div></div>
    <div class="col-6 col-md-3"><div class="kpi-card"><div class="kpi-icon"><i class="bi bi-cloud"></i></div><div class="kpi-value">{{ bodegas|length }}</div><div class="kpi-label">Bodegas</div></div></div>
    <div class="col-6 col-md-3"><div class="kpi-card"><div class="kpi-icon"><i class="bi bi-people"></i></div><div class="kpi-value">{{ tecnicos|length }}</div><div class="kpi-label">TÃ©cnicos</div></div></div>
    <div class="col-6 col-md-3"><div class="kpi-card"><div class="kpi-icon"><i class="bi bi-diagram-3"></i></div><div class="kpi-value">{{ '%.2f'|format(total_superficie or 0) }}</div><div class="kpi-label">Superficie Total (ha)</div></div></div>
  </div>

  <!-- ========= HUERTOS ========= -->
  <h4 class="text-success mb-3"><i class="bi bi-tree-fill"></i> Huertos</h4>
  <div class="d-flex flex-column gap-3 fade-in">
    {% for h in huertos %}
    <div class="card huerto-card p-3">
      <div class="row align-items-center g-3">
        <div class="col-md-1 text-center">
          <div class="display-6 text-success"><i class="bi bi-tree"></i></div>
          <span class="badge bg-light text-success">ID {{ h.id }}</span>
        </div>
        <div class="col-md-5">
          <h5 class="fw-bold text-success mb-1">{{ h.nombre }}</h5>
          <div class="small text-muted"><i class="bi bi-geo-alt"></i> {{ h.ubicacion or "â€”" }}</div>
          <div class="row small mt-2">
            <div class="col-6"><b>Cultivo:</b> {{ h.tipo_cultivo or "â€”" }}</div>
            <div class="col-6"><b>Superficie:</b> {{ '%.2f'|format(h.superficie_ha or 0) }} ha</div>
          </div>
          <div class="mt-1 small"><b>TÃ©cnico:</b>
            {% if h.responsable %}
              <span class="badge bg-success-subtle text-success-emphasis">{{ h.responsable.name }}</span>
            {% else %}
              <span class="badge bg-warning-subtle text-warning-emphasis">Sin asignar</span>
            {% endif %}
          </div>
        </div>
        <div class="col-md-3 text-center text-md-start border-start">
          <div><b>Bodegas:</b> {{ h.bodegas|length }}</div>
          <div class="small text-muted mt-2"><i class="bi bi-calendar-event"></i> {{ h.updated_at.strftime('%d-%m-%Y') if h.updated_at else 'â€”' }}</div>
        </div>
        <div class="col-md-3 text-center text-md-end d-flex flex-wrap gap-2 justify-content-md-end">
          <a href="{{ url_for('admin.bitacora_huerto', huerto_id=h.id) }}" class="btn btn-outline-primary btn-sm"><i class="bi bi-clock-history"></i> BitÃ¡cora</a>
          <a href="{{ url_for('admin.registrar_actividad_huerto', huerto_id=h.id) }}" class="btn btn-outline-info btn-sm"><i class="bi bi-plus"></i> Nueva</a>
          <a href="{{ url_for('geo.mapa') }}?focus=huerto:{{ h.id }}" class="btn btn-outline-success btn-sm"><i class="bi bi-geo-alt"></i> Mapa</a>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- ========= BODEGAS ========= -->
  <h4 class="text-warning mt-5 mb-3"><i class="bi bi-box-seam"></i> Bodegas</h4>
  <div class="row g-4">
    {% for b in bodegas %}
    <div class="col-md-6 col-lg-4">
      <div class="card bodega-card p-3 shadow-sm">
        <h5 class="fw-bold text-warning"><i class="bi bi-house"></i> {{ b.nombre }}</h5>
        <p class="small text-muted mb-2"><i class="bi bi-geo-alt"></i> {{ b.ubicacion or "â€”" }}</p>
        <div class="small mb-2"><b>Huerto:</b> {{ b.huerto.nombre if b.huerto else "â€”" }}</div>
        <div class="small"><b>Responsable:</b> {{ b.responsable.name if b.responsable else "Sin asignar" }}</div>
        <div class="d-flex gap-2 mt-3">
          <a href="{{ url_for('admin.ver_quimicos', bodega_id=b.id) }}" class="btn btn-outline-success btn-sm"><i class="bi bi-flask"></i> QuÃ­micos</a>
          <a href="{{ url_for('admin.editar_bodega', bodega_id=b.id) }}" class="btn btn-outline-secondary btn-sm"><i class="bi bi-pencil"></i> Editar</a>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- ========= TÃ‰CNICOS ========= -->
  <h4 class="text-info mt-5 mb-3"><i class="bi bi-person-gear"></i> TÃ©cnicos</h4>
  <div class="card shadow-sm fade-in">
    <table class="table mb-0 align-middle">
      <thead class="table-light">
        <tr><th>Nombre</th><th>Email</th><th class="text-end">Acciones</th></tr>
      </thead>
      <tbody>
        {% for t in tecnicos %}
        <tr>
          <td><i class="bi bi-person-circle text-success"></i> {{ t.name }}</td>
          <td class="text-muted small">{{ t.email }}</td>
          <td class="text-end">
            <a href="{{ url_for('admin.reset_password', tecnico_id=t.id) }}" class="btn btn-sm btn-outline-warning"><i class="bi bi-shield-lock"></i></a>
            <a href="{{ url_for('admin.editar_tecnico', tecnico_id=t.id) }}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-pencil-square"></i></a>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="3" class="text-center text-muted">No hay tÃ©cnicos registrados.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- ========= RECOMENDACIONES ========= -->
  <h4 class="text-primary mt-5 mb-3"><i class="bi bi-chat-square-dots"></i> Recomendaciones recientes</h4>
  <div class="card border-info shadow-sm fade-in">
    <div class="card-body p-3" style="max-height: 250px; overflow-y: auto;">
      {% if ultimas_recomendaciones %}
      <ul class="list-group list-group-flush">
        {% for r in ultimas_recomendaciones %}
        <li class="list-group-item small">
          <b class="text-success">{{ r.tecnico.name }}</b>: {{ r.contenido|truncate(60) }}
          <br><span class="text-muted"><i class="bi bi-calendar-event"></i> {{ r.fecha.strftime('%d-%m-%Y') }}</span>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <div class="text-muted text-center">Sin recomendaciones aÃºn.</div>
      {% endif %}
      <div class="text-center mt-3">
        <a href="{{ url_for('admin.recomendar') }}" class="btn btn-info text-white btn-sm"><i class="bi bi-plus-circle"></i> Agregar RecomendaciÃ³n</a>
      </div>
    </div>
  </div>
</div>

<!-- ========= AGROBOT JS ========= -->
<script>
(function(){
  const box=document.getElementById('agrobotBox'),
        showBtn=document.getElementById('showAgrobotBtn'),
        hideBtn=document.getElementById('hideAgrobotBtn'),
        KEY='agrobotHiddenAdmin';
  function toggle(hidden){
    box.style.display=hidden?'none':'block';
    showBtn.style.display=hidden?'inline-flex':'none';
  }
  toggle(localStorage.getItem(KEY)==='true');
  hideBtn.addEventListener('click',()=>{localStorage.setItem(KEY,'true');toggle(true);});
  showBtn.addEventListener('click',()=>{localStorage.setItem(KEY,'false');toggle(false);});
})();
</script>
{% endblock %}
