{% extends "base.html" %}
{% block title %}Bitácora del Huerto{% endblock %}

{% block content %}
<div class="container py-4">
  <h2 class="mb-3 text-success"><i class="bi bi-tree"></i> Bitácora de {{ huerto.nombre }}</h2>
  <div class="mb-2">
    <span class="me-3"><strong>Ubicación:</strong> {{ huerto.ubicacion or "—" }}</span>
    <span><strong>Técnico:</strong> {{ huerto.responsable.name if huerto.responsable else "Sin asignar" }}</span>
  </div>
  <div class="mb-4 d-flex gap-2">
    <a href="{{ url_for('admin.registrar_actividad_huerto', huerto_id=huerto.id) }}" class="btn btn-success">
      <i class="bi bi-plus-lg"></i> Nueva Actividad
    </a>
    <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-outline-secondary">Volver</a>
  </div>

  <!-- Resumen rápido -->
  <div class="mb-4">
    <span class="badge rounded-pill bg-success fs-6 me-2">{{ actividades|length }} actividades</span>
    {% if lista_anios %}
      <span class="badge bg-light text-dark">Años registrados: {{ lista_anios|join(', ') }}</span>
    {% endif %}
  </div>

  <!-- Filtros -->
  <form method="get" class="row g-2 mb-4">
    <div class="col-md-3">
      <select name="anio" class="form-select">
        <option value="">Todos los años</option>
        {% for anio in lista_anios %}
          <option value="{{ anio }}" {% if anio_seleccionado==anio %}selected{% endif %}>{{ anio }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <select name="tipo" class="form-select">
        <option value="">Todas las actividades</option>
        <option value="control_plagas" {% if tipo_seleccionado=='control_plagas' %}selected{% endif %}>Control Plagas</option>
        <option value="poda" {% if tipo_seleccionado=='poda' %}selected{% endif %}>Poda</option>
        <option value="riego" {% if tipo_seleccionado=='riego' %}selected{% endif %}>Riego</option>
        <option value="fertilizacion" {% if tipo_seleccionado=='fertilizacion' %}selected{% endif %}>Fertilización</option>
        <option value="cosecha" {% if tipo_seleccionado=='cosecha' %}selected{% endif %}>Cosecha</option>
        <option value="otra" {% if tipo_seleccionado=='otra' %}selected{% endif %}>Otra</option>
      </select>
    </div>
    <div class="col-md-2">
      <button class="btn btn-outline-success w-100" type="submit"><i class="bi bi-funnel"></i> Filtrar</button>
    </div>
  </form>

  <!-- Timeline mejorado -->
  <div class="timeline-pro position-relative">
    {% for act in actividades %}
    <div class="timeline-item mb-4">
      <div class="timeline-dot {{ tipo_color(act.tipo) }}">
        <i class="bi {{ tipo_icono(act.tipo) }}"></i>
      </div>
      <div class="timeline-content card shadow-sm border-0">
        <div class="card-header d-flex justify-content-between align-items-center py-2 px-3">
          <span class="fw-bold text-capitalize">{{ act.tipo|replace("_", " ") }}</span>
          <span class="text-muted"><i class="bi bi-calendar-event"></i> {{ act.fecha.strftime('%d-%m-%Y') }}</span>
        </div>
        <div class="card-body py-2 px-3">
          <p class="mb-2">{{ act.descripcion }}</p>
          <small class="text-muted d-block mb-1">
            Responsable: {{ act.responsable }}
          </small>
          {% if act.resultado %}
            <span class="badge bg-info">Resultado: {{ act.resultado }}</span>
          {% endif %}
        </div>
        <div class="card-footer py-2 px-3 d-flex gap-2">
          {# Botón "detalle" (quítalo si no tienes endpoint aún) #}
          {# <a href="{{ url_for('admin.detalle_actividad', actividad_id=act.id) }}" class="btn btn-outline-secondary btn-sm">Detalle</a> #}
          <span class="badge bg-light text-dark">{{ act.producto or "" }}</span>
          <span class="badge bg-light text-dark">{{ act.plaga or "" }}</span>
        </div>
      </div>
    </div>
    {% else %}
      <div class="alert alert-info text-center">No hay actividades para este filtro.</div>
    {% endfor %}
    <div class="timeline-line"></div>
  </div>
</div>

<!-- Timeline PRO CSS -->
<style>
.timeline-pro {
  position: relative;
  padding-left: 2.5rem;
}
.timeline-line {
  position: absolute;
  top: 0; left: 18px; width: 4px; height: 100%;
  background: #43a047;
  z-index: 0;
  border-radius: 2px;
}
.timeline-item {
  position: relative;
  z-index: 1;
  margin-bottom: 1.5rem;
  display: flex;
  align-items: flex-start;
}
.timeline-dot {
  width: 36px; height: 36px;
  background: #fff;
  border: 4px solid #43a047;
  border-radius: 50%;
  position: relative;
  left: -36px;
  z-index: 2;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.25rem;
}
.timeline-dot.bg-fertilizacion { border-color: #ffb300; color: #ffb300;}
.timeline-dot.bg-riego        { border-color: #29b6f6; color: #29b6f6;}
.timeline-dot.bg-poda         { border-color: #6d4c41; color: #6d4c41;}
.timeline-dot.bg-cosecha      { border-color: #d84315; color: #d84315;}
.timeline-dot.bg-control_plagas { border-color: #e53935; color: #e53935;}
.timeline-dot.bg-otra         { border-color: #789262; color: #789262;}
.timeline-content {
  margin-left: 12px;
  width: 100%;
}
</style>
{% endblock %}

