{% extends "base.html" %}
{% block title %}Qu√≠micos ‚Äì {{ bodega.nombre }}{% endblock %}

{% block content %}
<div class="container py-4">

  {# ===== AgroBot (plegable) ===== #}
  <div id="agrobot-box" class="card shadow-sm border-0 mb-4">
    <div class="card-body d-flex gap-3 flex-wrap align-items-start">
      <div class="display-6">ü§ñ</div>
      <div class="flex-grow-1">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
          <div>
            <h5 class="mb-1">AgroBot ‚Äî Bodega ‚Äú{{ bodega.nombre }}‚Äù</h5>
            <p class="text-muted small mb-2">
              Revisa stock, filtra por tipo y act√∫a r√°pido. Te dejo algunos atajos üëá
            </p>
          </div>
          <button id="agrobot-hide" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-eye-slash"></i> Ocultar
          </button>
        </div>
        
  
        </div>
      </div>
    </div>
  </div>

  {# ===== Flash ===== #}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, msg in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ msg }} <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  {# ===== Encabezado + toolbar ===== #}
  <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3">
    <div>
      <h4 class="mb-0">Qu√≠micos en <span class="text-success">{{ bodega.nombre }}</span></h4>
      <div class="text-muted small">
        Huerto: {{ bodega.huerto.nombre if bodega.huerto else "‚Äî" }}
      </div>
    </div>
    <div class="d-flex gap-2">
      <a href="{{ url_for('tecnico.agregar_quimico', bodega_id=bodega.id) }}" class="btn btn-success">
        <i class="bi bi-plus-lg"></i> Agregar qu√≠mico
      </a>
      <a href="{{ url_for('tecnico.mis_bodegas') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Mis bodegas
      </a>
    </div>
  </div>

  {# ===== KPIs r√°pidos ===== #}
  {% set total_items = quimicos|length %}
  {% set total_litros = (quimicos|map(attribute='cantidad_litros')|sum) or 0 %}
  {% set tipos_contador = {} %}
  {% for q in quimicos %}
    {% set _ = tipos_contador.__setitem__(q.tipo, (tipos_contador.get(q.tipo, 0) + 1)) %}
  {% endfor %}

  <div class="row g-3 mb-3">
    <div class="col-6 col-md-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="text-muted small">Productos</div>
          <div class="fs-4 fw-bold">{{ total_items }}</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="text-muted small">Litros totales</div>
          <div class="fs-4 fw-bold">{{ '%.2f'|format(total_litros) }} L</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="text-muted small mb-2">Por tipo</div>
          <div class="d-flex flex-wrap gap-2">
            {% for tipo, cnt in tipos_contador.items() %}
              <span class="badge text-bg-light border">
                <i class="bi bi-tag"></i> {{ tipo|capitalize }}: <b>{{ cnt }}</b>
              </span>
            {% else %}
              <span class="text-muted small">Sin datos</span>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

  {# ===== Filtros UI ===== #}
  <div class="card border-0 shadow-sm mb-3">
    <div class="card-body">
      <div class="row g-2 align-items-end">
        <div class="col-12 col-md-6">
          <label class="form-label small text-muted">Buscar</label>
          <input id="q-search" type="text" class="form-control" placeholder="Nombre, descripci√≥n‚Ä¶">
        </div>
        <div class="col-6 col-md-3">
          <label class="form-label small text-muted">Tipo</label>
          {% set tipos = quimicos|map(attribute='tipo')|list|unique|list %}
          <select id="q-type" class="form-select">
            <option value="">Todos</option>
            {% for t in tipos|sort %}
              <option value="{{ t }}">{{ t|capitalize }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-6 col-md-3">
          <label class="form-label small text-muted">Orden</label>
          <select id="q-sort" class="form-select">
            <option value="nombre-asc">Nombre (A‚ÄìZ)</option>
            <option value="nombre-desc">Nombre (Z‚ÄìA)</option>
            <option value="litros-desc">Litros (‚Üì)</option>
            <option value="litros-asc">Litros (‚Üë)</option>
            <option value="fecha-desc">Ingreso (reciente)</option>
            <option value="fecha-asc">Ingreso (antiguo)</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  {# ===== Grid de tarjetas ===== #}
  {% if quimicos %}
    <div id="cards-wrap" class="row g-3">
      {% for q in quimicos %}
        {% set bajo = (q.cantidad_litros is not none) and (q.cantidad_litros <= 5) %}
        <div class="col-12 col-md-6 col-lg-4 q-card"
             data-nombre="{{ q.nombre|lower }}"
             data-descripcion="{{ (q.descripcion or '')|lower }}"
             data-tipo="{{ q.tipo|lower }}"
             data-litros="{{ q.cantidad_litros or 0 }}"
             data-fecha="{{ q.fecha_ingreso.isoformat() if q.fecha_ingreso }}">
          <div class="card h-100 border-0 shadow-sm">
            <div class="card-body d-flex flex-column">
              <div class="d-flex justify-content-between align-items-start mb-1">
                <h6 class="mb-0">{{ q.nombre }}</h6>
                <span class="badge rounded-pill text-bg-light border">{{ q.tipo|capitalize }}</span>
              </div>

              <div class="text-muted small mb-2">
                Ingreso: {{ q.fecha_ingreso.strftime('%d-%m-%Y') if q.fecha_ingreso else '‚Äî' }}
              </div>

              {% if q.descripcion %}
                <div class="small mb-2">{{ q.descripcion }}</div>
              {% endif %}

              <div class="mt-auto d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-2">
                  <span class="badge {{ 'text-bg-danger' if bajo else 'text-bg-success' }}">
                    {{ 'Bajo stock' if bajo else 'OK' }}
                  </span>
                  <span class="badge text-bg-secondary">
                    {{ '%.2f'|format(q.cantidad_litros or 0) }} L
                  </span>
                </div>
                <div class="d-flex gap-2">
                  <a href="{{ url_for('tecnico.editar_quimico', quimico_id=q.id) }}"
                     class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-pencil"></i>
                  </a>
                  <form action="{{ url_for('tecnico.eliminar_quimico', quimico_id=q.id) }}"
                        method="post" onsubmit="return confirm('¬øEliminar {{ q.nombre }}?');">
                    <button class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="text-muted">No hay qu√≠micos registrados en esta bodega.</div>
  {% endif %}

  {# FAB para reabrir AgroBot #}
  <button id="agrobot-reopen" class="btn btn-success position-fixed bottom-0 end-0 m-3 d-none">
    <i class="bi bi-robot"></i> AgroBot
  </button>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(function(){
  // ===== AgroBot persistencia =====
  const KEY='agrobot_quimicos_hidden';
  const box=document.getElementById('agrobot-box');
  const hide=document.getElementById('agrobot-hide');
  const reopen=document.getElementById('agrobot-reopen');
  function apply(){ const h=localStorage.getItem(KEY)==='1';
    box?.classList.toggle('d-none', h);
    reopen?.classList.toggle('d-none', !h);
  }
  hide?.addEventListener('click', ()=>{ localStorage.setItem(KEY,'1'); apply(); });
  reopen?.addEventListener('click', ()=>{ localStorage.setItem(KEY,'0'); apply(); window.scrollTo({top:0,behavior:'smooth'}); });
  apply();

  // ===== Filtros/orden din√°micos =====
  const wrap=document.getElementById('cards-wrap');
  const cards=[...document.querySelectorAll('.q-card')];
  const q=document.getElementById('q-search');
  const type=document.getElementById('q-type');
  const sort=document.getElementById('q-sort');

  function match(c){
    const qv=(q.value||'').trim().toLowerCase();
    const tv=(type.value||'').toLowerCase();
    const n=c.dataset.nombre||'';
    const d=c.dataset.descripcion||'';
    const t=c.dataset.tipo||'';
    const hit = (!qv || n.includes(qv) || d.includes(qv));
    const okT = (!tv || t===tv);
    return hit && okT;
  }

  function painter(){
    cards.forEach(c=>c.classList.toggle('d-none', !match(c)));
  }

  function sorter(){
    const mode=sort.value;
    const mapped=cards.filter(c=>!c.classList.contains('d-none')).map(c=>{
      const nombre=c.dataset.nombre||'';
      const litros=parseFloat(c.dataset.litros||'0');
      const fecha=c.dataset.fecha?Date.parse(c.dataset.fecha):0;
      return {el:c, nombre, litros, fecha};
    });

    const cmp={
      "nombre-asc": (a,b)=>a.nombre.localeCompare(b.nombre),
      "nombre-desc": (a,b)=>b.nombre.localeCompare(a.nombre),
      "litros-asc": (a,b)=>a.litros-b.litros,
      "litros-desc": (a,b)=>b.litros-a.litros,
      "fecha-asc": (a,b)=>a.fecha-b.fecha,
      "fecha-desc": (a,b)=>b.fecha-a.fecha,
    }[mode] || ((a,b)=>0);

    mapped.sort(cmp);
    const frag=document.createDocumentFragment();
    mapped.forEach(m=>frag.appendChild(m.el));
    wrap?.appendChild(frag);
  }

  q?.addEventListener('input', ()=>{ painter(); sorter(); });
  type?.addEventListener('change', ()=>{ painter(); sorter(); });
  sort?.addEventListener('change', sorter);

  // init
  painter(); sorter();
})();
</script>
{% endblock %}
